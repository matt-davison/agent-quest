#!/bin/bash
# Pre-commit hook for Agent Quest
# Validates that players only modify their own files

set -e

# Get the GitHub username of the committer
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
GITHUB_USER=$("$SCRIPT_DIR/get-github-user.sh")

if [ -z "$GITHUB_USER" ]; then
    echo "ERROR: Could not determine GitHub username"
    exit 1
fi

echo "Validating commit as: $GITHUB_USER"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Track validation errors
ERRORS=""

for file in $STAGED_FILES; do
    # Check player files - players can only modify their own directory
    if [[ "$file" =~ ^players/([^/]+)/ ]]; then
        file_owner="${BASH_REMATCH[1]}"
        if [ "$file_owner" != "$GITHUB_USER" ] && [ "$file_owner" != "System" ]; then
            ERRORS="$ERRORS\n  - $file (owned by $file_owner)"
        fi
    fi

    # Check ledger files - players can only modify their own ledger
    if [[ "$file" =~ ^tokes/ledgers/([^/]+)\.yaml$ ]]; then
        ledger_owner="${BASH_REMATCH[1]}"
        if [ "$ledger_owner" != "$GITHUB_USER" ] && [ "$ledger_owner" != "System" ]; then
            ERRORS="$ERRORS\n  - $file (owned by $ledger_owner)"
        fi
    fi

    # Check claims - validate the github field matches the committer for new claims
    if [[ "$file" =~ ^tokes/claims/.*\.yaml$ ]]; then
        # For new or modified claims, check if it's being created/modified by the right person
        if git diff --cached "$file" | grep -q "^+github:"; then
            claimed_by=$(git diff --cached "$file" | grep "^+github:" | head -1 | sed 's/.*github: *"\([^"]*\)".*/\1/')
            if [ -n "$claimed_by" ] && [ "$claimed_by" != "$GITHUB_USER" ] && [ "$claimed_by" != "System" ]; then
                ERRORS="$ERRORS\n  - $file (claiming as $claimed_by, but you are $GITHUB_USER)"
            fi
        fi
    fi
done

if [ -n "$ERRORS" ]; then
    echo ""
    echo "=========================================="
    echo "COMMIT BLOCKED: Unauthorized file changes"
    echo "=========================================="
    echo ""
    echo "You ($GITHUB_USER) attempted to modify files you don't own:"
    echo -e "$ERRORS"
    echo ""
    echo "Players can only modify:"
    echo "  - players/$GITHUB_USER/*"
    echo "  - tokes/ledgers/$GITHUB_USER.yaml"
    echo "  - Claims with github: \"$GITHUB_USER\""
    echo ""
    exit 1
fi

echo "All file ownership checks passed."
exit 0
